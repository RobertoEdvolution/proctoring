define("quizaccess_proctoring/proctoring",["jquery","core/ajax","core/notification","core/str"],function(e,t,n,i){const a=async function(){const e=[{key:"facenotfoundoncam",component:"quizaccess_proctoring"},{key:"wrong_during_taking_image",component:"quizaccess_proctoring"},{key:"wrong_during_taking_screenshot",component:"quizaccess_proctoring"},{key:"enable_web_camera_before_submitting",component:"quizaccess_proctoring"},{key:"webcam",component:"quizaccess_proctoring"},{key:"videonotavailable",component:"quizaccess_proctoring"}];try{const t=await i.get_strings(e);return{facenotfoundoncam:t[0],wrongduringtakingimage:t[1],wrongduringtakingscreenshot:t[2],enablewebcamerabeforesubmitting:t[3],webcam:t[4],videonotavailable:t[5]}}catch(e){return n.exception(e),{}}};e("#id_submitbutton").prop("disabled",!0),e(function(){e("#id_submitbutton").prop("disabled",!0),e("#id_proctoring").on("change",function(){e("#id_submitbutton").prop("disabled",!this.checked)})});const o=()=>{try{const e=document.getElementsByClassName("alert");e.length>0&&Array.from(e).forEach(e=>{e.style.display="none"})}catch(e){n.exception(e)}};let c=3e4;const s=async(e,t)=>{const n=await faceapi.detectAllFaces(e);if(0!==n.length){let i=n[0].box;await(async(e,t,n)=>{const i=[new faceapi.Rect(t.x,t.y,t.width,t.height)];let a=await faceapi.extractFaces(e,i);0!==a.length&&a.forEach(e=>{n.src=e.toDataURL()})})(e,i,t)}};return{async setup(i,r){const d=await a();if(null!==r&&await faceapi.nets.ssdMobilenetv1.loadFromUri(r),c=i.camshotdelay,null!==document.getElementById("page-mod-quiz-summary")&&document.getElementById("page-mod-quiz-summary").innerHTML.length)return!1;if(null!==document.getElementById("page-mod-quiz-review")&&document.getElementById("page-mod-quiz-review").innerHTML.length)return!1;const u=i.image_width;let l=0,g=!1,m=null;e("body").append(`<div class="proctoring-fixed-webcam-box d-flex"><video id="video">${d.videonotavailable}</video><img id="cropimg" src="" alt=""/><canvas id="canvas" style="display:none;"></canvas><div class="output" style="display:none;"><img id="photo" alt="The picture will appear in this box."/></div></div>`);const p=document.getElementById("video"),f=document.getElementById("canvas"),h=document.getElementById("photo");(e=>{let t=0,n=0,i=0,a=0;const o=o=>{o.preventDefault(),t=i-o.clientX,n=a-o.clientY,i=o.clientX,a=o.clientY,e.style.top=e.offsetTop-n+"px",e.style.left=e.offsetLeft-t+"px",e.style.bottom=e.offsetTop-n+200+"px",e.style.right=e.offsetLeft-t+200+"px"},c=()=>{document.onmouseup=null,document.onmousemove=null};e.onmousedown=e=>{e.preventDefault(),i=e.clientX,a=e.clientY,document.onmouseup=c,document.onmousemove=o}})(p);const y=async()=>{const a=f.getContext("2d");if(u&&l){f.width=u,f.height=l,a.drawImage(p,0,0,u,l),m=f.toDataURL("image/png"),h.setAttribute("src",m),i.webcampicture=m;let v,w,b=e("#cropimg");null!==r&&await s(h,b),b.src?(null!==r&&o(),v=1,w=b.src):(null!==r&&(g=d.facenotfoundoncam,y="error",o(),n.addNotification({message:g,type:y})),v=0,w="");var c={methodname:"quizaccess_proctoring_send_camshot",args:{courseid:i.courseid,screenshotid:i.id,quizid:i.quizid,webcampicture:m,imagetype:1,parenttype:"camshot_image",faceimage:w,facefound:v}};t.call([c])[0].done(function(e){e.warnings.length>=1&&p&&n.addNotification({message:d.wrongduringtakingimage,type:"error"})}).fail(n.exception)}else(()=>{const e=f.getContext("2d");e.fillStyle="#AAA",e.fillRect(0,0,f.width,f.height),m=f.toDataURL("image/png"),h.setAttribute("src",m)})();var g,y};return navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then(function(e){p.srcObject=e,p.play()}).catch(function(){}),p&&(p.addEventListener("canplay",function(){g||(l=p.videoHeight/(p.videoWidth/u),isNaN(l)&&(l=u/(4/3)),p.setAttribute("width",u),p.setAttribute("height",l),f.setAttribute("width",u),f.setAttribute("height",l),g=!0)},!1),p.addEventListener("click",async function(e){await y(),e.preventDefault()},!1),setTimeout(y,3e3),setInterval(y,c)),!0},async init(i){let o=0,c=!1,s=!1,r=null,d=null,u=null,l=null;const g=i.image_width;function m(){if(s){var e=d.getContext("2d");e.fillStyle="#AAA",e.fillRect(0,0,d.width,d.height),l=d.toDataURL("image/png"),u.setAttribute("src",l)}}return await async function(){r=document.getElementById("video"),d=document.getElementById("canvas"),u=document.getElementById("photo"),r&&(navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then(function(e){r.srcObject=e,r.play(),s=!0,n.addNotification({message:i.cameraallow,type:"success"})}).catch(function(){n.addNotification({message:i.allowcamerawarning,type:"warning"})}),r.addEventListener("canplay",function(){c||(o=r.videoHeight/(r.videoWidth/g),isNaN(o)&&(o=g/(4/3)),r.setAttribute("width",g),r.setAttribute("height",o),d.setAttribute("width",g),d.setAttribute("height",o),c=!0)},!1),r.addEventListener("click",async function(c){await async function(){const c=await a();var s=d.getContext("2d");if(g&&o){e(document).trigger("screenshoottaken"),d.width=g,d.height=o,s.drawImage(r,0,0,g,o),l=d.toDataURL("image/png"),u.setAttribute("src",l);var p={methodname:"quizaccess_proctoring_send_camshot",args:{courseid:i.courseid,screenshotid:i.id,quizid:i.quizid,webcampicture:l,imagetype:1}};t.call([p])[0].done(async function(e){e.warnings.length>=1&&n.addNotification({message:c.wrongduringtakingscreenshot,type:"error"})}).fail(n.exception)}else m()}(),c.preventDefault()},!1)),m()}(),l}}});
//# sourceMappingURL=proctoring.min.js.map